name: æœ€å°åŒ–æ„å»º

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: 'ç›®æ ‡æ¶æ„'
        required: true
        default: 'arm64'
        type: choice
        options:
        - arm64
        - arm32
        - universal

jobs:
  minimal-build:
    name: æœ€å°åŒ–æ„å»ºAPK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: ğŸ“‹ ç¯å¢ƒæ£€æŸ¥
      run: |
        flutter --version
        flutter doctor
    
    - name: ğŸ”§ Androidé…ç½®
      run: |
        flutter config --android-sdk $ANDROID_SDK_ROOT
        yes | flutter doctor --android-licenses || true
    
    - name: ğŸ§¹ æ¸…ç†
      run: flutter clean
    
    - name: ğŸ“¦ è·å–ä¾èµ–
      run: |
        flutter pub get
        cd packages/api && flutter pub get && cd ../..
        cd packages/bluetooth && flutter pub get && cd ../..
        cd packages/file_picker && flutter pub get && cd ../..
        cd packages/video_player && flutter pub get && cd ../..
    
    - name: ğŸ”¨ æ„å»ºAPK
      run: |
        case "${{ github.event.inputs.architecture }}" in
          "arm64")
            echo "æ„å»ºARM64ç‰ˆæœ¬..."
            flutter build apk --debug --target-platform android-arm64
            ;;
          "arm32")
            echo "æ„å»ºARM32ç‰ˆæœ¬..."
            flutter build apk --debug --target-platform android-arm
            ;;
          "universal")
            echo "æ„å»ºé€šç”¨ç‰ˆæœ¬..."
            flutter build apk --debug
            ;;
        esac
    
    - name: ğŸ“± æŸ¥æ‰¾APKæ–‡ä»¶
      run: |
        echo "æŸ¥æ‰¾ç”Ÿæˆçš„APKæ–‡ä»¶..."
        find . -name "*.apk" -type f
        
        echo "æ£€æŸ¥æ ‡å‡†è¾“å‡ºç›®å½•..."
        ls -la build/app/outputs/flutter-apk/ || echo "æ ‡å‡†è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        
        echo "æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ä½ç½®..."
        find build -name "*.apk" -type f || echo "buildç›®å½•ä¸­æœªæ‰¾åˆ°APK"
        find android -name "*.apk" -type f || echo "androidç›®å½•ä¸­æœªæ‰¾åˆ°APK"
    
    - name: ğŸ“¦ æ•´ç†APK
      run: |
        mkdir -p output
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        ARCH="${{ github.event.inputs.architecture }}"
        
        # æŸ¥æ‰¾å¹¶å¤åˆ¶APKæ–‡ä»¶
        if find build -name "*.apk" -type f | head -1 | read apk_file; then
          echo "æ‰¾åˆ°APKæ–‡ä»¶: $apk_file"
          cp "$apk_file" "output/ghosten-player-${ARCH}-debug-${TIMESTAMP}.apk"
          echo "âœ… APKå·²å¤åˆ¶åˆ°outputç›®å½•"
        else
          echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
          
          # å°è¯•æ‰‹åŠ¨æ„å»º
          echo "å°è¯•æ‰‹åŠ¨Gradleæ„å»º..."
          cd android
          ./gradlew assembleDebug --stacktrace || echo "Gradleæ„å»ºä¹Ÿå¤±è´¥äº†"
          
          # å†æ¬¡æŸ¥æ‰¾
          find . -name "*.apk" -type f
          cd ..
        fi
        
        echo "è¾“å‡ºç›®å½•å†…å®¹:"
        ls -la output/ || echo "outputç›®å½•ä¸ºç©º"
    
    - name: â¬†ï¸ ä¸Šä¼ APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: minimal-build-${{ github.event.inputs.architecture }}-${{ github.run_number }}
        path: |
          output/*.apk
          build/app/outputs/flutter-apk/*.apk
          android/app/build/outputs/apk/**/*.apk
        retention-days: 30
    
    - name: ğŸ“Š æ„å»ºæŠ¥å‘Š
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "ç›®æ ‡æ¶æ„: ${{ github.event.inputs.architecture }}"
        echo "Flutterç‰ˆæœ¬: $(flutter --version | head -1)"
        echo "Javaç‰ˆæœ¬: $(java -version 2>&1 | head -1)"
        
        if [ -f "output/ghosten-player-*.apk" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ"
          ls -la output/
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥ä¸Šä¼ çš„artifactsä¸­çš„è°ƒè¯•ä¿¡æ¯"
        fi
