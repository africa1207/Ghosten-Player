name: æ‰‹åŠ¨æ„å»ºAPK

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'æ„å»ºæè¿°ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'DLNAä¿®å¤ç‰ˆæœ¬'

jobs:
  build:
    name: æ„å»ºAndroid APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'
        cache: true
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        flutter pub get
        flutter pub get --directory=packages/api
        flutter pub get --directory=packages/bluetooth
        flutter pub get --directory=packages/file_picker
        flutter pub get --directory=packages/video_player
    
    - name: ğŸ”§ Flutteræ£€æŸ¥
      run: flutter doctor -v
    
    - name: ğŸ§¹ æ¸…ç†ç¼“å­˜
      run: flutter clean
    
    - name: ğŸ”¨ æ„å»ºDebug APK
      run: |
        echo "å¼€å§‹æ„å»ºDebugç‰ˆæœ¬..."
        flutter build apk --debug --target-platform android-arm64
        flutter build apk --debug --split-per-abi
    
    - name: ğŸ“± æ„å»ºRelease APK  
      run: |
        echo "å¼€å§‹æ„å»ºReleaseç‰ˆæœ¬..."
        flutter build apk --release --target-platform android-arm64
        flutter build apk --release --split-per-abi
    
    - name: ğŸ“‹ æ•´ç†APKæ–‡ä»¶
      run: |
        mkdir -p release
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        
        # Debugç‰ˆæœ¬
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          cp build/app/outputs/flutter-apk/app-debug.apk release/ghosten-player-debug-${TIMESTAMP}.apk
        fi
        
        if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-debug.apk" ]; then
          cp build/app/outputs/flutter-apk/app-arm64-v8a-debug.apk release/ghosten-player-arm64-debug-${TIMESTAMP}.apk
        fi
        
        # Releaseç‰ˆæœ¬
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          cp build/app/outputs/flutter-apk/app-release.apk release/ghosten-player-release-${TIMESTAMP}.apk
        fi
        
        if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk release/ghosten-player-arm64-release-${TIMESTAMP}.apk
        fi
        
        echo "ğŸ“± æ„å»ºçš„APKæ–‡ä»¶ï¼š"
        ls -la release/
    
    - name: â¬†ï¸ ä¸Šä¼ APK
      uses: actions/upload-artifact@v4
      with:
        name: ghosten-player-apk-${{ github.run_number }}
        path: release/*.apk
        retention-days: 30
    
    - name: âœ… æ„å»ºå®Œæˆ
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "ğŸ“ æè¿°: ${{ github.event.inputs.description }}"
        echo "ğŸ”— ä¸‹è½½é“¾æ¥å°†åœ¨Actionsé¡µé¢çš„Artifactsä¸­æä¾›"
        echo "ğŸ“± åŒ…å«Debugå’ŒReleaseä¸¤ä¸ªç‰ˆæœ¬"
