name: è°ƒè¯•æ„å»ºé—®é¢˜

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'è°ƒè¯•çº§åˆ«'
        required: true
        default: 'verbose'
        type: choice
        options:
        - verbose
        - info

jobs:
  debug-build:
    name: è°ƒè¯•æ„å»º
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: ğŸ¦ è®¾ç½®Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: ğŸ“‹ æ˜¾ç¤ºè¯¦ç»†ç¯å¢ƒä¿¡æ¯
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a
        echo "=== Javaä¿¡æ¯ ==="
        java -version
        javac -version
        echo "=== Flutterä¿¡æ¯ ==="
        flutter --version
        flutter doctor -v
        echo "=== Dartä¿¡æ¯ ==="
        dart --version
        echo "=== Android SDKä¿¡æ¯ ==="
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_SDK_ROOT/ || echo "Android SDKç›®å½•ä¸å­˜åœ¨"
        echo "==================="
    
    - name: ğŸ”§ é…ç½®Androidç¯å¢ƒ
      run: |
        echo "é…ç½®Android SDK..."
        flutter config --android-sdk $ANDROID_SDK_ROOT
        
        echo "æ¥å—Androidè®¸å¯..."
        yes | flutter doctor --android-licenses || true
        
        echo "æ£€æŸ¥Androidå·¥å…·..."
        which adb || echo "adbæœªæ‰¾åˆ°"
        which aapt || echo "aaptæœªæ‰¾åˆ°"
    
    - name: ğŸ§¹ æ¸…ç†é¡¹ç›®
      run: |
        echo "æ¸…ç†Flutteré¡¹ç›®..."
        flutter clean
        
        echo "æ¸…ç†Androidé¡¹ç›®..."
        cd android
        ./gradlew clean || echo "Gradleæ¸…ç†å¤±è´¥"
        cd ..
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        echo "å®‰è£…ä¸»é¡¹ç›®ä¾èµ–..."
        flutter pub get
        
        echo "å®‰è£…å­åŒ…ä¾èµ–..."
        for package in packages/*/; do
          if [ -f "$package/pubspec.yaml" ]; then
            echo "å®‰è£… $package ä¾èµ–..."
            (cd "$package" && flutter pub get)
          fi
        done
    
    - name: ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "æ£€æŸ¥é¡¹ç›®ç»“æ„..."
        ls -la
        echo "æ£€æŸ¥Androidç›®å½•..."
        ls -la android/
        echo "æ£€æŸ¥appç›®å½•..."
        ls -la android/app/
        echo "æ£€æŸ¥Gradleæ–‡ä»¶..."
        cat android/gradle/wrapper/gradle-wrapper.properties
        echo "æ£€æŸ¥build.gradle..."
        head -20 android/app/build.gradle
    
    - name: ğŸ”¨ å°è¯•Gradleæ„å»º
      run: |
        echo "è¿›å…¥Androidç›®å½•..."
        cd android
        
        echo "æ£€æŸ¥Gradleç‰ˆæœ¬..."
        ./gradlew --version
        
        echo "åˆ—å‡ºGradleä»»åŠ¡..."
        ./gradlew tasks --all | head -50
        
        echo "å°è¯•æ„å»ºDebug APK..."
        ./gradlew assembleDebug --stacktrace --info || echo "Gradleæ„å»ºå¤±è´¥"
        
        echo "æ£€æŸ¥æ„å»ºè¾“å‡º..."
        find . -name "*.apk" -type f || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        cd ..
    
    - name: ğŸ”¨ å°è¯•Flutteræ„å»º
      run: |
        echo "å°è¯•Flutteræ„å»º..."
        flutter build apk --debug --verbose --target-platform android-arm64 || echo "Flutteræ„å»ºå¤±è´¥"
        
        echo "æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•..."
        find build -type f -name "*.apk" || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        echo "æ£€æŸ¥æ„å»ºæ—¥å¿—..."
        ls -la build/ || echo "buildç›®å½•ä¸å­˜åœ¨"
        ls -la build/app/ || echo "build/appç›®å½•ä¸å­˜åœ¨"
        ls -la build/app/outputs/ || echo "build/app/outputsç›®å½•ä¸å­˜åœ¨"
    
    - name: ğŸ“Š æ”¶é›†è°ƒè¯•ä¿¡æ¯
      if: always()
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯æ”¶é›† ==="
        echo "Flutterç‰ˆæœ¬:"
        flutter --version
        
        echo "Gradleç‰ˆæœ¬:"
        cd android && ./gradlew --version && cd ..
        
        echo "æ„å»ºç›®å½•å†…å®¹:"
        find build -type f -name "*.apk" 2>/dev/null || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        echo "Androidæ„å»ºç›®å½•:"
        find android -type f -name "*.apk" 2>/dev/null || echo "Androidç›®å½•ä¸­æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        echo "é”™è¯¯æ—¥å¿—:"
        find . -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \; 2>/dev/null || echo "æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
    
    - name: ğŸ“¤ ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_number }}
        path: |
          build/
          android/build/
          android/app/build/
        retention-days: 7
