name: ç®€å•æ„å»ºAPK

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'æ„å»ºæè¿°'
        required: false
        default: 'DLNAä¿®å¤ç‰ˆæœ¬'

jobs:
  build:
    name: æ„å»ºAPK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: â˜• è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: ğŸ¦ è®¾ç½®Flutter (æœ€æ–°stable)
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: ğŸ“‹ æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        flutter --version
        dart --version
        java -version
        echo "==================="
    
    - name: ğŸ”§ Flutterç¯å¢ƒæ£€æŸ¥
      run: flutter doctor -v
    
    - name: ğŸ§¹ æ¸…ç†é¡¹ç›®
      run: flutter clean
    
    - name: ğŸ“¦ è·å–ä¸»é¡¹ç›®ä¾èµ–
      run: |
        echo "è·å–ä¸»é¡¹ç›®ä¾èµ–..."
        flutter pub get
    
    - name: ğŸ“¦ è·å–å­åŒ…ä¾èµ–
      run: |
        echo "è·å–APIåŒ…ä¾èµ–..."
        cd packages/api && flutter pub get && cd ../..
        
        echo "è·å–è“ç‰™åŒ…ä¾èµ–..."
        cd packages/bluetooth && flutter pub get && cd ../..
        
        echo "è·å–æ–‡ä»¶é€‰æ‹©å™¨åŒ…ä¾èµ–..."
        cd packages/file_picker && flutter pub get && cd ../..
        
        echo "è·å–è§†é¢‘æ’­æ”¾å™¨åŒ…ä¾èµ–..."
        cd packages/video_player && flutter pub get && cd ../..
    
    - name: ğŸ”¨ æ„å»ºDebug APK
      run: |
        echo "æ„å»ºDebugç‰ˆæœ¬..."
        flutter build apk --debug
    
    - name: ğŸ”¨ æ„å»ºRelease APK
      run: |
        echo "æ„å»ºReleaseç‰ˆæœ¬..."
        flutter build apk --release
    
    - name: ğŸ“± æ•´ç†APKæ–‡ä»¶
      run: |
        mkdir -p output
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        
        # å¤åˆ¶APKæ–‡ä»¶
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          cp build/app/outputs/flutter-apk/app-debug.apk output/ghosten-player-debug-${TIMESTAMP}.apk
          echo "âœ… Debug APKå·²ç”Ÿæˆ"
        fi
        
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          cp build/app/outputs/flutter-apk/app-release.apk output/ghosten-player-release-${TIMESTAMP}.apk
          echo "âœ… Release APKå·²ç”Ÿæˆ"
        fi
        
        echo "ğŸ“± ç”Ÿæˆçš„APKæ–‡ä»¶ï¼š"
        ls -la output/
    
    - name: â¬†ï¸ ä¸Šä¼ APK
      uses: actions/upload-artifact@v4
      with:
        name: ghosten-player-dlna-fix-${{ github.run_number }}
        path: output/*.apk
        retention-days: 30
    
    - name: âœ… æ„å»ºå®Œæˆ
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "ğŸ“ æè¿°: ${{ github.event.inputs.description }}"
        echo "ğŸ”— è¯·åœ¨Actionsé¡µé¢çš„Artifactsä¸­ä¸‹è½½APKæ–‡ä»¶"
